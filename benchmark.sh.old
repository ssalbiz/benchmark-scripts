#/bin/bash

export SWD=`dirname $0`
export ANALYSIS=$2

if [ -n "$1" ]; then
  echo "Running benchmark: $2 $1"
else
  echo "Usage: ${0} [benchmark name] [analysis name]"
  echo "Possible analyses: alias, ds-finder"
  exit
fi

if [ -e ${SWD}/settings-base.sh ]; then
  . ${SWD}/settings-base.sh $1 
else 
  echo "settings-base.sh not found. Aborting."
  exit 127
fi


echo "LOOKING IN ${CLASSES_DIR}"

if [ ! -n "$MAIN_CLASS" ]; then
   ## if no main class is set use whichever one soot infers
   
   echo java -Xmx1800M -cp ${CLASSPATH} ${SOOT_MAIN} ${SOOT_OPTIONS} --d ${OUTPUT_DIR} -pp --cp ${CLASSPATH} --allow-phantom-refs $CLASS_LIST  | tee $OUTPUT_FILE 
   
   java -Xmx1800M -cp ${CLASSPATH} ${SOOT_MAIN} ${SOOT_OPTIONS} --d ${OUTPUT_DIR} -pp --cp ${CLASSPATH} --allow-phantom-refs $CLASS_LIST 2>&1 | tee  -a $OUTPUT_FILE
   
   echo "terminal output logged at $OUTPUT_FILE"

else
   ## cycle through given entry points one by one in order to maximize code coverage.
   for (( i = 0; i < ${#MAIN_CLASS[@]}; i++ )); do
   	echo "processing from next entry point"

	echo java -Xmx1800M -cp ${CLASSPATH} ${SOOT_MAIN} ${SOOT_OPTIONS} --d ${OUTPUT_DIR} -pp --cp ${CLASSPATH} --allow-phantom-refs $CLASS_LIST -main-class ${MAIN_CLASS[$i]} | tee $OUTPUT_FILE.$i 
	
	java -Xmx1800M -cp ${CLASSPATH} ${SOOT_MAIN} ${SOOT_OPTIONS} --d ${OUTPUT_DIR} -pp --cp ${CLASSPATH} --allow-phantom-refs $CLASS_LIST -main-class ${MAIN_CLASS[$i]} 2>&1 | tee -a $OUTPUT_FILE.$i
	
	sleep 5;

   	echo "terminal output logged at $OUTPUT_FILE.$i"
   done
fi
